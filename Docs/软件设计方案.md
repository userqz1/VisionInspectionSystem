# 视觉检测系统软件设计方案

## 一、项目概述

### 1.1 项目信息
| 项目 | 说明 |
|------|------|
| 软件名称 | 视觉检测系统 (Vision Inspection System) |
| 开发语言 | C# WinForms |
| .NET版本 | .NET Framework 4.7.1+ |
| 开发平台 | Visual Studio 2022 |
| 运行环境 | Windows 10/11 x64 |
| 相机品牌 | Basler |
| 图像处理 | Cognex VisionPro |

### 1.2 运行环境要求
| 项目 | 最低要求 | 推荐配置 |
|------|----------|----------|
| 操作系统 | Windows 10 x64 | Windows 10/11 x64 |
| CPU | Intel i5 | Intel i7 或更高 |
| 内存 | 8GB | 16GB 或更高 |
| 硬盘 | 100GB SSD | 256GB SSD |
| 显卡 | 集成显卡 | 独立显卡 |
| .NET | .NET Framework 4.7.1 | .NET Framework 4.8 |
| VisionPro | VisionPro 9.0+ | VisionPro 9.8+ |
| Pylon SDK | Pylon 6.0+ | Pylon 7.0+ |

### 1.3 功能概述
- TCP/IP 通讯模块
- Basler 相机控制模块
- VisionPro 图像处理集成
- 三级权限管理系统
- 检测界面与数据统计
- 版型管理功能

---

## 二、系统架构设计

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        表现层 (UI Layer)                         │
│  ┌───────────┬───────────┬───────────┬───────────┬───────────┐  │
│  │  主界面   │  相机设置  │  通讯设置  │  检测界面  │  数据统计  │  │
│  │ MainForm │ CameraForm│ CommForm  │ InspectForm│ StatsForm │  │
│  └───────────┴───────────┴───────────┴───────────┴───────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       业务逻辑层 (BLL)                           │
│  ┌───────────┬───────────┬───────────┬───────────┬───────────┐  │
│  │ 相机管理  │  通讯管理  │  检测管理  │  权限管理  │  版型管理  │  │
│  │CameraManager│CommManager│InspectManager│AuthManager│ModelManager│
│  └───────────┴───────────┴───────────┴───────────┴───────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       数据访问层 (DAL)                           │
│  ┌───────────┬───────────┬───────────┬───────────┬───────────┐  │
│  │ 配置文件  │  日志记录  │  数据存储  │  图像存储  │  版型文件  │  │
│  │ConfigHelper│ LogHelper │DataStorage│ImageStorage│ModelStorage│
│  └───────────┴───────────┴───────────┴───────────┴───────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       硬件抽象层 (HAL)                           │
│  ┌─────────────────────┐    ┌─────────────────────┐             │
│  │   Basler Pylon SDK  │    │  Cognex VisionPro   │             │
│  │   (相机驱动)        │    │  (图像处理引擎)     │             │
│  └─────────────────────┘    └─────────────────────┘             │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 项目结构

```
VisionInspectionSystem/
├── VisionInspectionSystem.sln          # 解决方案文件
├── VisionInspectionSystem/             # 主项目
│   ├── Program.cs                      # 程序入口
│   ├── App.config                      # 应用配置
│   │
│   ├── Forms/                          # 窗体目录
│   │   ├── MainForm.cs                 # 主窗体
│   │   ├── LoginForm.cs                # 登录窗体
│   │   ├── CameraSettingForm.cs        # 相机设置窗体
│   │   ├── CommunicationForm.cs        # 通讯设置窗体
│   │   ├── InspectionForm.cs           # 检测界面窗体
│   │   ├── StatisticsForm.cs           # 数据统计窗体
│   │   ├── ModelManageForm.cs          # 版型管理窗体
│   │   └── UserManageForm.cs           # 用户管理窗体
│   │
│   ├── UserControls/                   # 用户控件
│   │   ├── CameraDisplayControl.cs     # 相机显示控件
│   │   ├── ResultDisplayControl.cs     # 结果显示控件
│   │   ├── LogDisplayControl.cs        # 日志显示控件
│   │   └── StatisticsChartControl.cs   # 统计图表控件
│   │
│   ├── BLL/                            # 业务逻辑层
│   │   ├── CameraManager.cs            # 相机管理
│   │   ├── CommunicationManager.cs     # 通讯管理
│   │   ├── InspectionManager.cs        # 检测管理
│   │   ├── AuthenticationManager.cs    # 权限管理
│   │   ├── ModelManager.cs             # 版型管理
│   │   └── StatisticsManager.cs        # 统计管理
│   │
│   ├── DAL/                            # 数据访问层
│   │   ├── ConfigHelper.cs             # 配置助手
│   │   ├── LogHelper.cs                # 日志助手
│   │   ├── DataStorage.cs              # 数据存储
│   │   ├── ImageStorage.cs             # 图像存储
│   │   └── ModelStorage.cs             # 版型存储
│   │
│   ├── HAL/                            # 硬件抽象层
│   │   ├── BaslerCamera.cs             # Basler相机封装
│   │   ├── VisionProProcessor.cs       # VisionPro处理封装
│   │   └── TcpCommunication.cs         # TCP通讯封装
│   │
│   ├── Models/                         # 数据模型
│   │   ├── UserInfo.cs                 # 用户信息
│   │   ├── CameraConfig.cs             # 相机配置
│   │   ├── CommunicationConfig.cs      # 通讯配置
│   │   ├── InspectionResult.cs         # 检测结果
│   │   ├── ModelConfig.cs              # 版型配置
│   │   └── StatisticsData.cs           # 统计数据
│   │
│   ├── Common/                         # 公共类
│   │   ├── Constants.cs                # 常量定义
│   │   ├── Enums.cs                    # 枚举定义
│   │   ├── GlobalVariables.cs          # 全局变量
│   │   └── Utils.cs                    # 工具类
│   │
│   └── Resources/                      # 资源文件
│       ├── Images/                     # 图片资源
│       └── Icons/                      # 图标资源
│
├── Config/                             # 配置文件目录
│   ├── SystemConfig.xml                # 系统配置
│   ├── CameraConfig.xml                # 相机配置
│   └── UserConfig.xml                  # 用户配置
│
├── Models/                             # 版型文件目录
│   └── [ModelName]/
│       ├── ModelConfig.xml             # 版型配置
│       └── VisionProJob.vpp            # VisionPro作业文件
│
├── Data/                               # 数据目录
│   ├── Logs/                           # 日志目录
│   ├── Images/                         # 图像存储目录
│   └── Statistics/                     # 统计数据目录
│
└── Libs/                               # 第三方库
    ├── Basler.Pylon.dll
    └── Cognex.VisionPro.dll
```

---

## 三、模块详细设计

### 3.1 TCP/IP 通讯模块

#### 3.1.1 功能需求
| 功能 | 描述 |
|------|------|
| 服务端/客户端模式 | 支持作为TCP服务端或客户端运行 |
| 连接管理 | 支持连接、断开、重连机制 |
| 数据收发 | 支持字符串/字节数组收发 |
| 协议解析 | 支持自定义协议格式 |
| 模拟测试 | 支持与SocketTool等工具通讯测试 |

#### 3.1.2 类设计

```csharp
// TCP通讯类
public class TcpCommunication
{
    // 属性
    public string LocalIP { get; set; }
    public int LocalPort { get; set; }
    public string RemoteIP { get; set; }
    public int RemotePort { get; set; }
    public bool IsConnected { get; }
    public CommunicationMode Mode { get; set; }  // Server/Client

    // 事件
    public event EventHandler<string> DataReceived;
    public event EventHandler<ConnectionState> ConnectionStateChanged;
    public event EventHandler<string> ErrorOccurred;

    // 方法
    public bool StartServer();
    public bool StopServer();
    public bool Connect();
    public bool Disconnect();
    public bool Send(string message);
    public bool Send(byte[] data);
}
```

#### 3.1.3 通讯协议设计

```
命令格式: [STX][命令码][数据长度][数据内容][校验码][ETX]

示例命令:
- 触发拍照: T1
- 获取结果: G1
- 心跳检测: H1

响应格式:
- OK: OK,[结果数据]
- NG: NG,[错误码]
- 坐标结果: OK,X:100.00,Y:200.00,R:45.00
```

#### 3.1.4 界面设计

```
┌─────────────────────────────────────────────────────────────┐
│ TCP/IP 通讯设置                                              │
├─────────────────────────────────────────────────────────────┤
│  通讯模式: ○ 服务端  ● 客户端                                │
│                                                             │
│  ┌─ 本地设置 ─────────────┐  ┌─ 远程设置 ─────────────┐    │
│  │ IP地址: [192.168.1.10] │  │ IP地址: [192.168.1.20] │    │
│  │ 端口号: [8000       ]  │  │ 端口号: [8001       ]  │    │
│  └────────────────────────┘  └────────────────────────┘    │
│                                                             │
│  [连接] [断开] [清空]                 状态: ● 已连接         │
│                                                             │
│  ┌─ 发送区域 ──────────────────────────────────────────┐   │
│  │ [                                              ]     │   │
│  │ [发送] ☑ 自动换行  ☐ 16进制发送                     │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─ 接收区域 ──────────────────────────────────────────┐   │
│  │ [2024-01-01 10:00:00] 收到: T1                       │   │
│  │ [2024-01-01 10:00:01] 发送: OK,X:100.00,Y:200.00    │   │
│  │                                                      │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

### 3.2 Basler 相机模块

#### 3.2.1 功能需求
| 功能 | 描述 |
|------|------|
| 初始化 | 自动搜索并初始化相机 |
| 取图 | 支持单帧取图和连续取图 |
| 存图 | 支持BMP/JPG/PNG格式保存 |
| 参数调整 | 曝光时间、增益、白平衡等 |
| 触发模式 | 软触发、外触发、自由运行 |
| 信息显示 | 相机名称、序列号、型号等 |

#### 3.2.2 类设计

```csharp
// Basler相机封装类
public class BaslerCamera : IDisposable
{
    // 相机信息
    public string CameraName { get; }
    public string SerialNumber { get; }
    public string ModelName { get; }
    public string CameraID { get; }
    public bool IsConnected { get; }
    public bool IsGrabbing { get; }

    // 参数属性
    public double ExposureTime { get; set; }        // 曝光时间 (μs)
    public double Gain { get; set; }                // 增益
    public TriggerMode TriggerMode { get; set; }    // 触发模式
    public TriggerSource TriggerSource { get; set; } // 触发源
    public int Width { get; set; }                  // 图像宽度
    public int Height { get; set; }                 // 图像高度

    // 事件
    public event EventHandler<Bitmap> ImageGrabbed;
    public event EventHandler<string> ErrorOccurred;
    public event EventHandler<CameraState> StateChanged;

    // 方法
    public static List<CameraInfo> EnumerateCameras();  // 枚举相机
    public bool Open(string serialNumber);               // 打开相机
    public bool Close();                                 // 关闭相机
    public bool StartGrabbing();                         // 开始采集
    public bool StopGrabbing();                          // 停止采集
    public Bitmap GrabOne();                             // 单帧采集
    public bool SoftwareTrigger();                       // 软触发
    public bool SaveImage(string path, ImageFormat format); // 保存图像
    public void LoadParameters(string configPath);       // 加载参数
    public void SaveParameters(string configPath);       // 保存参数
}

// 触发模式枚举
public enum TriggerMode
{
    Off,        // 自由运行
    On          // 触发模式
}

// 触发源枚举
public enum TriggerSource
{
    Software,   // 软触发
    Line1,      // 外触发Line1
    Line2,      // 外触发Line2
    Line3       // 外触发Line3
}
```

#### 3.2.3 界面设计

```
┌─────────────────────────────────────────────────────────────────────┐
│ 相机设置                                                             │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─ 相机列表 ────────────────────┐  ┌─ 相机信息 ─────────────────┐ │
│  │ [刷新]                        │  │ 相机名称: Camera_1         │ │
│  │ ┌────────────────────────┐   │  │ 序列号:   12345678         │ │
│  │ │ ● Camera_1 (12345678)  │   │  │ 型号:     acA1920-40gc     │ │
│  │ │ ○ Camera_2 (87654321)  │   │  │ IP地址:   192.168.1.100    │ │
│  │ └────────────────────────┘   │  │ 状态:     ● 已连接         │ │
│  │ [连接] [断开]                 │  └─────────────────────────────┘ │
│  └───────────────────────────────┘                                  │
│                                                                     │
│  ┌─ 图像显示 ─────────────────────────────────────────────────────┐│
│  │                                                                 ││
│  │                      [实时图像显示区域]                          ││
│  │                                                                 ││
│  │                                                                 ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                     │
│  ┌─ 参数设置 ─────────────────────────────────────────────────────┐│
│  │  曝光时间(μs): [10000    ] [---|-------] 范围: 100-100000      ││
│  │  增益(dB):     [5.0      ] [-----|-----] 范围: 0-24            ││
│  │                                                                 ││
│  │  触发模式: ○ 自由运行  ● 触发模式                               ││
│  │  触发源:   ○ 软触发    ○ Line1    ○ Line2                      ││
│  │                                                                 ││
│  │  [应用参数] [保存参数] [加载参数]                               ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                     │
│  [单帧采集] [连续采集] [停止采集] [保存图像]                        │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 3.3 VisionPro 图像处理集成模块

#### 3.3.1 功能需求
| 功能 | 描述 |
|------|------|
| 作业加载 | 加载VisionPro作业文件(.vpp) |
| 图像处理 | 执行VisionPro检测流程 |
| 结果获取 | 获取检测结果和坐标数据 |
| 离线测试 | 支持加载本地图像进行测试 |

#### 3.3.2 类设计

```csharp
// VisionPro处理器封装类
public class VisionProProcessor : IDisposable
{
    // 属性
    public string JobFilePath { get; }
    public bool IsJobLoaded { get; }
    public double LastRunTime { get; }  // 上次运行时间(ms)

    // 事件
    public event EventHandler<InspectionResult> InspectionCompleted;
    public event EventHandler<string> ErrorOccurred;

    // 方法
    public bool LoadJob(string vppFilePath);
    public bool UnloadJob();
    public InspectionResult Run(Bitmap image);
    public InspectionResult RunOffline(string imagePath);
    public void SetInputImage(Bitmap image);
    public object GetToolResult(string toolName);
    public void SaveJob(string vppFilePath);
}

// 检测结果类
public class InspectionResult
{
    public bool IsPass { get; set; }           // 是否合格
    public double X { get; set; }              // X坐标
    public double Y { get; set; }              // Y坐标
    public double Angle { get; set; }          // 角度
    public double Score { get; set; }          // 匹配分数
    public double RunTime { get; set; }        // 运行时间
    public string Message { get; set; }        // 结果消息
    public Bitmap ResultImage { get; set; }    // 结果图像
    public List<ToolResult> ToolResults { get; set; }  // 工具结果列表
    public DateTime TimeStamp { get; set; }    // 时间戳
}
```

---

### 3.4 权限管理模块

#### 3.4.1 权限等级设计

| 等级 | 角色 | 权限描述 |
|------|------|----------|
| Level 1 | 操作员 | 仅查看权限,可运行检测、查看结果和统计 |
| Level 2 | 工程师 | 可修改相机参数、版型切换、离线测试 |
| Level 3 | 管理员 | 全部权限,包括用户管理、系统配置 |

#### 3.4.2 功能权限矩阵

| 功能模块 | 操作员 | 工程师 | 管理员 |
|----------|--------|--------|--------|
| 运行检测 | ✓ | ✓ | ✓ |
| 查看结果 | ✓ | ✓ | ✓ |
| 查看统计 | ✓ | ✓ | ✓ |
| 相机参数调整 | ✗ | ✓ | ✓ |
| 版型切换 | ✗ | ✓ | ✓ |
| 离线测试 | ✗ | ✓ | ✓ |
| 通讯配置 | ✗ | ✓ | ✓ |
| 版型编辑 | ✗ | ✗ | ✓ |
| 用户管理 | ✗ | ✗ | ✓ |
| 系统配置 | ✗ | ✗ | ✓ |

#### 3.4.3 类设计

```csharp
// 用户等级枚举
public enum UserLevel
{
    Operator = 1,   // 操作员
    Engineer = 2,   // 工程师
    Admin = 3       // 管理员
}

// 用户信息类
public class UserInfo
{
    public string UserName { get; set; }
    public string Password { get; set; }  // 加密存储
    public UserLevel Level { get; set; }
    public DateTime CreateTime { get; set; }
    public DateTime LastLoginTime { get; set; }
}

// 权限管理类
public class AuthenticationManager
{
    public UserInfo CurrentUser { get; }
    public bool IsLoggedIn { get; }

    public event EventHandler<UserInfo> UserLoggedIn;
    public event EventHandler UserLoggedOut;

    public bool Login(string username, string password);
    public void Logout();
    public bool HasPermission(string permissionKey);
    public bool AddUser(UserInfo user);
    public bool DeleteUser(string username);
    public bool UpdateUser(UserInfo user);
    public List<UserInfo> GetAllUsers();
}
```

#### 3.4.4 登录界面设计

```
┌─────────────────────────────────────┐
│           用户登录                   │
├─────────────────────────────────────┤
│                                     │
│      ┌─────────────────────┐        │
│      │     [公司Logo]      │        │
│      │  视觉检测系统 V1.0  │        │
│      └─────────────────────┘        │
│                                     │
│   用户名: [________________]        │
│                                     │
│   密  码: [________________]        │
│                                     │
│           [登录]  [退出]            │
│                                     │
│   默认管理员: admin / admin123      │
│                                     │
└─────────────────────────────────────┘
```

---

### 3.5 检测界面模块

#### 3.5.1 功能需求
| 功能 | 描述 |
|------|------|
| 实时显示 | 实时显示相机图像和检测结果 |
| 结果显示 | 显示OK/NG状态、坐标、角度等 |
| 数据统计 | 实时显示检测数量、良率等 |
| 日志记录 | 记录检测过程和命令收发 |

#### 3.5.2 界面设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 视觉检测系统 V1.0                    [当前用户: admin]  [当前版型: Model_A] │
├─────────────────────────────────────────────────────────────────────────────┤
│ [运行] [停止] [离线测试] | [相机设置] [通讯设置] [版型管理] [数据统计] [系统] │
├────────────────────────────────────────────┬────────────────────────────────┤
│                                            │  ┌─ 检测结果 ───────────────┐ │
│                                            │  │                          │ │
│                                            │  │     ████  ██  ██         │ │
│                                            │  │     ██  ██ ██ ██         │ │
│      [实时图像显示区域]                     │  │     ██  ██ ████          │ │
│      640 x 480                             │  │     ████  ██  ██         │ │
│                                            │  │                          │ │
│                                            │  │     状态: OK / NG        │ │
│                                            │  └──────────────────────────┘ │
│                                            │                                │
│                                            │  ┌─ 坐标信息 ───────────────┐ │
│                                            │  │ X:     123.456  mm       │ │
│                                            │  │ Y:     234.567  mm       │ │
├────────────────────────────────────────────┤  │ 角度:   45.123  °        │ │
│  ┌─ 实时统计 ────────────────────────────┐ │  │ 得分:   98.5    %        │ │
│  │ 总数: 1000  OK: 950  NG: 50           │ │  │ 耗时:   125     ms       │ │
│  │ 良率: 95.0%  运行时间: 02:30:45       │ │  └──────────────────────────┘ │
│  └────────────────────────────────────────┘ │                                │
├────────────────────────────────────────────┴────────────────────────────────┤
│  ┌─ 运行日志 ───────────────────────────────────────────────────────────┐  │
│  │ [10:00:01] 收到命令: T1                                               │  │
│  │ [10:00:01] 执行拍照...                                                │  │
│  │ [10:00:02] 检测完成: OK, X:123.456, Y:234.567, R:45.123              │  │
│  │ [10:00:02] 发送结果: OK,123.456,234.567,45.123                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 3.6 数据统计模块

#### 3.6.1 功能需求
| 功能 | 描述 |
|------|------|
| 实时统计 | 当前批次的OK/NG数量和良率 |
| 历史查询 | 按日期、版型查询历史数据 |
| 图表展示 | 柱状图、折线图、饼图展示 |
| 数据导出 | 支持导出Excel报表 |

#### 3.6.2 界面设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 数据统计                                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  查询条件: 开始日期[2024-01-01] 结束日期[2024-01-31] 版型[All▼] [查询] [导出]│
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─ 统计概览 ──────────────────────────────────────────────────────────┐   │
│  │   总检测数        OK数量          NG数量          良率               │   │
│  │   ┌─────┐        ┌─────┐        ┌─────┐        ┌─────┐             │   │
│  │   │10000│        │ 9500│        │  500│        │95.0%│             │   │
│  │   └─────┘        └─────┘        └─────┘        └─────┘             │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─ 趋势图表 ──────────────────────────────────────────────────────────┐   │
│  │     ^                                                                │   │
│  │ 100%│    ___    ___         ___                                     │   │
│  │     │   /   \  /   \   ___/   \___                                  │   │
│  │  95%│──/─────\/─────\_/───────────\──────────────────               │   │
│  │     │                              \___                              │   │
│  │  90%│                                  \___/                         │   │
│  │     └────────────────────────────────────────────>                   │   │
│  │       1日  5日  10日  15日  20日  25日  30日                         │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─ 详细数据 ──────────────────────────────────────────────────────────┐   │
│  │ 日期        版型      总数    OK     NG    良率                      │   │
│  │ 2024-01-01  Model_A   500    480    20    96.0%                     │   │
│  │ 2024-01-01  Model_B   300    285    15    95.0%                     │   │
│  │ 2024-01-02  Model_A   600    570    30    95.0%                     │   │
│  │ ...                                                                  │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 3.7 版型管理模块

#### 3.7.1 功能需求
| 功能 | 描述 |
|------|------|
| 版型列表 | 显示所有可用版型 |
| 版型切换 | 快速切换不同产品版型 |
| 版型创建 | 创建新的检测版型 |
| 版型编辑 | 编辑版型参数配置 |
| 版型删除 | 删除不需要的版型 |

#### 3.7.2 版型配置结构

```xml
<?xml version="1.0" encoding="utf-8"?>
<ModelConfig>
    <BasicInfo>
        <ModelName>Model_A</ModelName>
        <Description>产品A检测版型</Description>
        <CreateTime>2024-01-01 10:00:00</CreateTime>
        <ModifyTime>2024-01-15 15:30:00</ModifyTime>
        <Creator>admin</Creator>
    </BasicInfo>

    <CameraSettings>
        <ExposureTime>10000</ExposureTime>
        <Gain>5.0</Gain>
        <TriggerMode>On</TriggerMode>
        <TriggerSource>Software</TriggerSource>
    </CameraSettings>

    <VisionProSettings>
        <JobFilePath>Models/Model_A/VisionProJob.vpp</JobFilePath>
    </VisionProSettings>

    <OutputFormat>
        <ResultFormat>OK,{X},{Y},{R}</ResultFormat>
        <DecimalPlaces>3</DecimalPlaces>
    </OutputFormat>
</ModelConfig>
```

#### 3.7.3 界面设计

```
┌─────────────────────────────────────────────────────────────────┐
│ 版型管理                                                         │
├─────────────────────────────────────────────────────────────────┤
│  ┌─ 版型列表 ────────────────┐  ┌─ 版型详情 ─────────────────┐ │
│  │ [新建] [删除] [刷新]      │  │ 版型名称: Model_A          │ │
│  │ ┌──────────────────────┐ │  │ 描    述: 产品A检测版型    │ │
│  │ │ ● Model_A            │ │  │ 创建时间: 2024-01-01       │ │
│  │ │ ○ Model_B            │ │  │ 修改时间: 2024-01-15       │ │
│  │ │ ○ Model_C            │ │  │ 创 建 人: admin            │ │
│  │ │                      │ │  │                            │ │
│  │ └──────────────────────┘ │  │ ┌─ 相机参数 ─────────────┐ │ │
│  │                          │  │ │ 曝光: 10000 μs         │ │ │
│  │ 当前版型: Model_A        │  │ │ 增益: 5.0 dB           │ │ │
│  │                          │  │ │ 触发: 软触发           │ │ │
│  │ [切换版型]               │  │ └────────────────────────┘ │ │
│  └───────────────────────────┘  │                            │ │
│                                 │ VisionPro作业:             │ │
│                                 │ [VisionProJob.vpp] [编辑]  │ │
│                                 │                            │ │
│                                 │ [保存配置] [加载配置]      │ │
│                                 └─────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

---

## 四、数据流设计

### 4.1 检测流程数据流

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ TCP命令 │───>│ 命令解析 │───>│ 相机取图 │───>│VisionPro│───>│ 结果发送 │
│  接收   │    │         │    │         │    │  检测   │    │         │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
                                  │              │              │
                                  ▼              ▼              ▼
                             ┌─────────┐   ┌─────────┐   ┌─────────┐
                             │ 图像存储 │   │ 结果显示 │   │ 数据统计 │
                             └─────────┘   └─────────┘   └─────────┘
```

### 4.2 状态机设计

```
                    ┌──────────────────────┐
                    │                      │
                    ▼                      │
┌────────┐     ┌────────┐     ┌────────┐  │  ┌────────┐
│  空闲  │────>│  就绪  │────>│  运行  │──┴─>│  错误  │
│  Idle  │     │  Ready │     │ Running│     │  Error │
└────────┘     └────────┘     └────────┘     └────────┘
    ▲              │              │              │
    │              │              │              │
    └──────────────┴──────────────┴──────────────┘
                      停止/重置
```

---

## 五、配置文件设计

### 5.1 系统配置 (SystemConfig.xml)

```xml
<?xml version="1.0" encoding="utf-8"?>
<SystemConfig>
    <General>
        <SoftwareName>视觉检测系统</SoftwareName>
        <Version>1.0.0</Version>
        <Language>zh-CN</Language>
        <AutoStart>false</AutoStart>
    </General>

    <Paths>
        <LogPath>Data/Logs</LogPath>
        <ImagePath>Data/Images</ImagePath>
        <ModelPath>Models</ModelPath>
        <ConfigPath>Config</ConfigPath>
    </Paths>

    <ImageSave>
        <SaveOK>true</SaveOK>
        <SaveNG>true</SaveNG>
        <MaxDays>30</MaxDays>
        <ImageFormat>jpg</ImageFormat>
    </ImageSave>
</SystemConfig>
```

### 5.2 通讯配置 (CommunicationConfig.xml)

```xml
<?xml version="1.0" encoding="utf-8"?>
<CommunicationConfig>
    <TCP>
        <Mode>Client</Mode>
        <LocalIP>192.168.1.10</LocalIP>
        <LocalPort>8000</LocalPort>
        <RemoteIP>192.168.1.20</RemoteIP>
        <RemotePort>8001</RemotePort>
        <Timeout>5000</Timeout>
        <AutoReconnect>true</AutoReconnect>
    </TCP>

    <Protocol>
        <TriggerCommand>T1</TriggerCommand>
        <HeartbeatCommand>H1</HeartbeatCommand>
        <HeartbeatInterval>5000</HeartbeatInterval>
    </Protocol>
</CommunicationConfig>
```

---

## 六、异常处理设计

### 6.1 异常分类

| 异常类型 | 描述 | 处理方式 |
|----------|------|----------|
| 相机异常 | 相机断开、取图失败 | 自动重连,报警提示 |
| 通讯异常 | TCP断开、超时 | 自动重连,记录日志 |
| 处理异常 | VisionPro执行失败 | 返回NG,记录详情 |
| 系统异常 | 内存不足、文件错误 | 记录日志,安全退出 |

### 6.2 日志设计

```
日志格式: [时间] [级别] [模块] [消息]

日志级别:
- DEBUG: 调试信息
- INFO:  一般信息
- WARN:  警告信息
- ERROR: 错误信息
- FATAL: 致命错误

示例:
[2024-01-01 10:00:00] [INFO]  [Camera] 相机连接成功: Camera_1 (12345678)
[2024-01-01 10:00:01] [INFO]  [TCP]    收到命令: T1
[2024-01-01 10:00:02] [INFO]  [Vision] 检测完成: OK, 耗时125ms
[2024-01-01 10:00:03] [ERROR] [Camera] 取图失败: 相机未连接
```

---

## 七、开发计划

### 7.1 开发阶段划分

| 阶段 | 内容 | 优先级 |
|------|------|--------|
| 第一阶段 | 基础框架搭建、界面布局、权限管理 | P0 |
| 第二阶段 | TCP通讯模块、Basler相机集成 | P0 |
| 第三阶段 | VisionPro集成、检测流程 | P0 |
| 第四阶段 | 版型管理、数据统计 | P1 |
| 第五阶段 | 优化调试、测试部署 | P1 |

### 7.2 所需第三方库

| 库名称 | 用途 | 版本 |
|--------|------|------|
| Basler.Pylon | Basler相机SDK | 最新版 |
| Cognex.VisionPro | 图像处理 | 9.x |
| Newtonsoft.Json | JSON处理 | 13.x |
| NLog | 日志记录 | 5.x |
| LiveCharts | 图表显示 | 0.9.x |

---

## 八、附录

### 8.1 默认账户

| 用户名 | 密码 | 权限等级 |
|--------|------|----------|
| admin | admin123 | 管理员 |
| engineer | eng123 | 工程师 |
| operator | op123 | 操作员 |

### 8.2 快捷键设计

| 快捷键 | 功能 |
|--------|------|
| F5 | 运行/停止检测 |
| F6 | 单帧采集 |
| F7 | 离线测试 |
| Ctrl+S | 保存配置 |
| Ctrl+L | 切换版型 |
| Esc | 退出当前界面 |

---

**文档版本**: V1.0
**编写日期**: 2024年
**作者**: Claude AI Assistant
